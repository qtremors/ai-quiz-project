{% extends 'base.html' %}
{% load static %}

{% block title %}Quiz Setup - {{ language_name }}{% endblock %}

{% block styles %}
<style>
    .setup-container { flex-grow: 1; padding: 48px 24px; max-width: 900px; width: 100%; margin: 0 auto; }
    .setup-card { background-color: var(--md-sys-color-surface-container); border-radius: 28px; padding: 40px; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2); }
    .setup-card h2 { font-size: 36px; font-weight: 700; color: var(--md-sys-color-primary); margin-top: 0; margin-bottom: 32px; text-align: center; }
    .form-group { margin-bottom: 32px; display: flex; flex-direction: column; }
    .form-group label { font-size: 16px; font-weight: 500; color: var(--md-sys-color-on-surface); margin-bottom: 8px; }
    select, input[type="text"], input[type="number"] { padding: 12px; background-color: var(--md-sys-color-surface-container-low); border: 1px solid var(--md-sys-color-outline); border-radius: 8px; color: var(--md-sys-color-on-surface); font-size: 16px; width: 100%; box-sizing: border-box; }
    #topics-container { display: flex; flex-wrap: wrap; gap: 12px; padding: 8px 0; }
    .topic-checkbox { display: none; }
    .topic-chip-label { background-color: var(--md-sys-color-surface-container-low); color: var(--md-sys-color-on-surface); border-radius: 8px; padding: 8px 12px; font-size: 14px; font-weight: 500; cursor: pointer; transition: background-color 0.2s, color 0.2s; border: 1px solid var(--md-sys-color-outline); }
    .topic-checkbox:checked + .topic-chip-label { background-color: var(--md-sys-color-primary-container); color: var(--md-sys-color-on-primary-container); border-color: var(--md-sys-color-primary); }
    .generate-btn-container { text-align: center; margin-top: 40px; }
    .generate-btn { position: relative; background-color: var(--md-sys-color-primary); color: var(--md-sys-color-on-primary); border: none; border-radius: 24px; padding: 12px 24px; font-size: 16px; font-weight: 700; cursor: pointer; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4); display: inline-flex; align-items: center; gap: 12px; justify-content: center; overflow: hidden; }
    .gemini-svg-icon { width: 24px; height: 24px; flex-shrink: 0; }
    .btn-text { white-space: nowrap; }
    .generate-btn.loading { pointer-events: none; }
    .generate-btn.loading .btn-text, .generate-btn.loading .gemini-svg-icon { opacity: 0.5; transition: opacity 0.3s; }
    .generate-btn.loading::before { content: ''; position: absolute; top: 50%; left: 50%; width: calc(100% + 24px); height: calc(100% + 24px); transform: translate(-50%, -50%); border-radius: 36px; background: conic-gradient(from 180deg at 50% 50%, var(--md-sys-color-surface) 0deg, var(--md-sys-color-primary) 360deg); animation: spin 1.5s linear infinite; z-index: 0; }
    .generate-btn.loading::after { content: ''; position: absolute; top: 2px; left: 2px; right: 2px; bottom: 2px; background: var(--md-sys-color-primary); border-radius: 22px; z-index: 1; }
    .generate-btn .gemini-svg-icon, .generate-btn .btn-text { position: relative; z-index: 2; }
    @keyframes spin { 0% { transform: translate(-50%, -50%) rotate(0deg); } 100% { transform: translate(-50%, -50%) rotate(360deg); } }
</style>
{% endblock %}

{% block content %}
<main class="setup-container">
    <div class="setup-card">
        <h2>Create Your {{ language_name }} Quiz</h2>

        {% if messages %}
            <div class="messages" style="margin-bottom: 24px; text-align: left;">
                {% for message in messages %}
                    <p style="color: #F2B8B5; background-color: #4E1613; padding: 12px 16px; border-radius: 8px; margin: 0;">
                        {{ message }}
                    </p>
                {% endfor %}
            </div>
        {% endif %}
        
        <form id="quiz-setup-form" action="{% url 'create_quiz' %}" method="POST">
            {% csrf_token %}
            <input type="hidden" name="language" value="{{ language_slug }}">

            <div class="form-group">
                <label for="level">Difficulty Level:</label>
                <select id="level" name="level">
                    <option value="beginner">Beginner</option>
                    <option value="intermediate" selected>Intermediate</option>
                    <option value="expert">Expert</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>Predefined Topics (Select one or more):</label>
                <div id="topics-container">
                    {% for topic in topics %}
                    <div>
                        <input type="checkbox" class="topic-checkbox" name="predefined_topics" value="{{ topic.name }}" id="topic-{{ topic.id }}">
                        <label class="topic-chip-label" for="topic-{{ topic.id }}">{{ topic.name }}</label>
                    </div>
                    {% empty %}
                        <p style="color: var(--md-sys-color-on-surface-variant);">No predefined topics found for {{ language_name }}. Add your own below!</p>
                    {% endfor %}
                </div>
            </div>
            
            <div class="form-group">
                <label for="custom_topics">Add Your Own Topics (comma-separated):</label>
                <input type="text" id="custom_topics" name="custom_topics" placeholder="e.g., 'Django ORM', 'uv Package Management'">
            </div>

            <div class="form-group">
                <label for="num-questions">Number of Questions (5-30):</label>
                <input type="number" id="num-questions" name="num_questions" min="5" max="30" value="10">
            </div>

            <div class="generate-btn-container">
                <button type="submit" class="generate-btn" id="generate-button">
                    <img src="{% static 'images/gemini.svg' %}" alt="Generate Icon" class="gemini-svg-icon">
                    <span class="btn-text">Generate Quiz</span>
                </button>
            </div>
        </form>
    </div>
</main>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    const quizForm = document.getElementById('quiz-setup-form');
    const generateButton = document.getElementById('generate-button');

    quizForm.addEventListener('submit', (event) => {

        const checkedTopics = document.querySelectorAll('input[name="predefined_topics"]:checked');
        const customTopicsInput = document.getElementById('custom_topics');
        const customTopicsValue = customTopicsInput.value.trim();


        if (checkedTopics.length === 0 && customTopicsValue === '') {
            event.preventDefault(); 
            
            alert('Please select at least one topic or enter a custom topic.');
            
            generateButton.classList.remove('loading');
            generateButton.disabled = false;
            
            return;
        }

        generateButton.classList.add('loading');
        generateButton.disabled = true;
    });
});
</script>
{% endblock %}