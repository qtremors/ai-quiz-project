{% extends 'base.html' %}
{% load static %}

{% block title %}Custom Quiz - Chat Generator{% endblock %}

{% block styles %}
<style>
    /* ======================================= */
    /* CHAT QUIZ SPECIFIC STYLES */
    /* ======================================= */
    .chat-layout {
        display: flex;
        flex-direction: column;
        height: calc(100vh - 64px); /* Full viewport height minus top bar */
        max-width: 900px;
        width: 100%;
        margin: 0 auto;
        background-color: var(--md-sys-color-surface-container);
    }
    
    .chat-header {
        padding: 16px 24px;
        border-bottom: 1px solid var(--md-sys-color-outline);
        display: flex;
        align-items: center;
        gap: 16px;
        flex-shrink: 0;
    }

    .chat-header h2 {
        margin: 0;
        font-size: 24px;
        color: var(--md-sys-color-on-surface);
    }

    .message-area {
        flex-grow: 1;
        padding: 24px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 16px;
    }
    
    .message-area p {
        max-width: 80%;
        padding: 12px 16px;
        border-radius: 20px;
        line-height: 1.5;
        margin: 0;
    }

    .system-message {
        background-color: var(--md-sys-color-primary-container);
        color: var(--md-sys-color-on-primary-container);
        align-self: flex-start;
        border-bottom-left-radius: 4px;
    }

    .user-message {
        background-color: var(--md-sys-color-secondary-container);
        color: var(--md-sys-color-on-secondary-container);
        align-self: flex-end;
        border-bottom-right-radius: 4px;
    }

    .system-message.error {
        background-color: #B3261E; /* MD3 Error Color */
        color: #FFFFFF;
    }

    .input-bar-wrapper {
        padding: 16px 24px;
        background-color: var(--md-sys-color-surface);
        border-top: 1px solid var(--md-sys-color-outline);
        flex-shrink: 0;
    }

    .input-bar {
        display: flex;
        align-items: center;
        gap: 12px;
        background-color: var(--md-sys-color-surface-container-high);
        border-radius: 28px;
        padding: 8px 16px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }

    .input-bar input {
        flex-grow: 1;
        padding: 8px 0;
        border: none;
        background: none;
        color: var(--md-sys-color-on-surface);
        font-size: 16px;
        outline: none;
    }

    .question-selector select {
        padding: 6px 10px;
        border-radius: 8px;
        background-color: var(--md-sys-color-surface-container-low);
        border: 1px solid var(--md-sys-color-outline);
    }

    .send-button {
        background: none; border: none; color: var(--md-sys-color-primary); cursor: pointer;
        padding: 8px; border-radius: 50%;
    }

    /* --- NEW: Loading Dots Animation --- */
    .loading-dots span {
        display: inline-block;
        animation: blink 1.4s infinite both;
    }
    .loading-dots span:nth-child(2) { animation-delay: 0.2s; }
    .loading-dots span:nth-child(3) { animation-delay: 0.4s; }

    @keyframes blink {
        0% { opacity: 0.2; }
        20% { opacity: 1; }
        100% { opacity: 0.2; }
    }
</style>
{% endblock %}

{% block content %}
<main class="chat-layout">
    <div class="chat-header">
        <span class="material-symbols-outlined" style="color: var(--md-sys-color-primary); font-size: 32px;">sparkle</span>
        <h2>AI Quiz Assistant</h2>
    </div>

    <div class="message-area" id="message-area">
        <p class="system-message">
            Hello! I can generate a quiz on any tech topic you like. For example:
            <strong>"Generate a quiz on Python decorators"</strong> or
            <strong>"Quiz me on modern CSS layout."</strong>
        </p>
    </div>

    <div class="input-bar-wrapper">
        <div class="input-bar">
            <div class="question-selector">
                <label for="num-questions-chat" class="sr-only">Questions</label>
                <select id="num-questions-chat" name="num_questions">
                    <option value="5">5 Qs</option>
                    <option value="10" selected>10 Qs</option>
                    <option value="15">15 Qs</option>
                    <option value="20">20 Qs</option>
                </select>
            </div>
            
            <input type="text" placeholder="Type your quiz request here..." id="chat-input">
            
            <button class="send-button" id="send-button">
                <span class="material-symbols-outlined">send</span>
            </button>
        </div>
    </div>
</main>
{% endblock %}

{% block scripts %}
<script>
    const messageArea = document.getElementById('message-area');
    const chatInput = document.getElementById('chat-input');
    const numQuestionsSelect = document.getElementById('num-questions-chat');
    const sendButton = document.getElementById('send-button');
    let isLoading = false;


    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();

                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');


    function addMessage(text, type) {
        const p = document.createElement('p');
        p.textContent = text;
        p.className = type;
        messageArea.appendChild(p);
        messageArea.scrollTop = messageArea.scrollHeight;
    }


    function showLoadingIndicator() {
        const p = document.createElement('p');
        p.className = 'system-message loading-dots';
        p.innerHTML = '<span>.</span><span>.</span><span>.</span>';
        p.id = 'loading-indicator'; // Give it an ID to find and remove it later
        messageArea.appendChild(p);
        messageArea.scrollTop = messageArea.scrollHeight;
    }
    

    function removeLoadingIndicator() {
        const indicator = document.getElementById('loading-indicator');
        if (indicator) {
            indicator.remove();
        }
    }


    async function sendMessage() {
        const userMessage = chatInput.value.trim();
        if (!userMessage || isLoading) return;

        isLoading = true;
        sendButton.style.opacity = '0.5';

        addMessage(userMessage, 'user-message');
        chatInput.value = '';
        showLoadingIndicator();

        try {
            const response = await fetch("{% url 'generate_from_chat' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken 
                },
                body: JSON.stringify({
                    message: userMessage,
                    num_questions: parseInt(numQuestionsSelect.value, 10)
                })
            });
            const data = await response.json();
            
            if (response.ok) {
                window.location.href = data.quiz_start_url;
            } else {
                addMessage(`Sorry, an error occurred: ${data.error}`, 'system-message error');
            }

        } catch (error) {
            addMessage('A network error occurred. Please try again.', 'system-message error');
        } finally {
            removeLoadingIndicator();
            isLoading = false;
            sendButton.style.opacity = '1';
        }
    }


    sendButton.addEventListener('click', sendMessage);
    chatInput.addEventListener('keydown', (event) => {
        if (event.key === 'Enter') {
            event.preventDefault();
            sendMessage();
        }
    });
</script>
{% endblock %}